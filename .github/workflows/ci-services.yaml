name: CI - Microservices

on:
  push:
    branches: ["main"]
    paths:
      - "services/**"
      - "infrastructure/**"
      - "gitops/**"
      - ".github/workflows/**"
      - ".semgrepignore"
  pull_request:
    branches: ["main"]
    paths:
      - "services/**"
      - "infrastructure/**"
      - "gitops/**"

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          # Ideally use something like 'paths-filter' here for distinct builds.
          # For demo, we just return all services.
          echo "matrix={\"service\":[\"frontend\",\"auth-service\",\"product-service\",\"order-service\",\"payment-service\",\"notification-service\"]}" >> $GITHUB_OUTPUT

  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.matrix != ''
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    runs-on: ubuntu-latest

    # Add OIDC and GitOps permissions
    permissions:
      id-token: write
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # ---- Security: SAST ----
      - name: Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto

      # ---- AWS Auth (OIDC) ----
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      # ---- Login to ECR ----
      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      # ---- Build & Scan ----
      - name: Build Image
        run: |
          docker build --no-cache -t ${{ matrix.service }}:${{ github.sha }} services/${{ matrix.service }}

      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ matrix.service }}:${{ github.sha }}
          exit-code: 1
          severity: CRITICAL,HIGH

      # ---- Push ----
      - name: Push Image
        run: |
          IMAGE_URL=${{ secrets.ECR_REGISTRY }}/enterprise-gitops/${{ matrix.service }}:${{ github.sha }}
          docker tag ${{ matrix.service }}:${{ github.sha }} $IMAGE_URL
          docker push $IMAGE_URL

      # ---- GitOps: Update Manifests (Robust) ----
      - name: Update GitOps Manifest and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          for i in {1..10}; do
            echo "Update attempt $i for ${{ matrix.service }}..."
            git fetch origin main
            git reset --hard origin/main
            
            yq eval ".services.\"${{ matrix.service }}\".tag = \"${{ github.sha }}\"" -i gitops/apps/values.yaml
            
            git add gitops/apps/values.yaml
            if git commit -m "chore(gitops): update ${{ matrix.service }} image tag to ${{ github.sha }} [skip ci]"; then
              if git push origin main; then
                echo "Successfully updated ${{ matrix.service }}"
                exit 0
              fi
            else
              if [[ $(yq eval ".services.\"${{ matrix.service }}\".tag" gitops/apps/values.yaml) == "${{ github.sha }}" ]]; then
                echo "Tag already updated for ${{ matrix.service }}."
                exit 0
              fi
            fi
            
            SLEEP_TIME=$((RANDOM % 10 + 2))
            echo "Retry in ${SLEEP_TIME}s..."
            sleep ${SLEEP_TIME}
          done
          exit 1
